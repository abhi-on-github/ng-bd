{% extends 'base.html' %}
{% load url from future %}
{% block main_content %}
<div class="row-fluid">
   <div class="span12">
      <h3 class="row-fluid smaller lighter blue">
         <span class="span2">
            Users
         </span>
         <span class="pull-right">
            {% if request.session.external_auth == 'undefined' %}
            <a href='{% url "createuser_view" %}'>
               <button class="btn btn-success btn-small">
                  <i class="icon-plus"></i>
                  Create
               </button>
            </a>
            {% else %}
            <a href='#'>
               <button class="btn btn-grey btn-small popover-notitle" data-rel="popover" data-placement="left" data-content='Cannot create users when external authentication is enabled'>
                  <i class="icon-plus"></i>
                  Create
               </button>
            </a>
            {% endif %}
         </span>
      </h3>

      <div class="space-6"></div>

      <div class="space-6"></div>

      <table id="users_table" class="table table-striped table-bordered table-hover bd-table" >
         {% include 'table_headers.html' %}
         <tbody>
            {% for row in data %}
            <tr>
               <td style="display:none">{{ row.id }}</td>
               <td class="row-extras-link">{{ row.name }}</td>
               <td>{{ row.description }}</td>
               <td>{{ row.num_tenants }}</td>
               {% if row.is_external %}
               <td>External Authentication</td>
               {% else %}
               <td>Internal</td>
               {% endif %}

               <td>
                  <div class="visible-desktop action-buttons row-actions"></div>
               </td>
            </tr>
            {% endfor %}
         </tbody>
      </table>
   </div>
</div>

<div class="row-fluid">
   <div class="span12">
      <div class="hr hr32 "></div>

      <h3 class="row-fluid header smaller lighter blue">Sessions</h3>
      <div class="widget-box transparent no-border" id='sessionsTable'>
         <div class="widget-header widget-header-large no-border">
            <h4></h4>
            <div class="widget-toolbar no-border">
               <a href='#'>
                  <button class="btn btn-danger btn-small table_delete">
                     <i class="icon-trash"></i>
                     Delete
                  </button>
               </a>
            </div>
         </div>
      </div>

      <table id="user_sessions" class="table table-striped table-bordered table-hover bd-table" >
         {% include 'table_headers.html' with headers=session_headers %}
         <tbody>
            {% for row in session_list %}
            <tr>
               <td class='center'>
                  <label><input type='checkbox'/><span class="lbl"></span></label>
               </td>
               <td style="display:none">{{ row.id }}</td>
               <td>{{ row.user_name }}</td>
               <td>{{ row.tenant_name }}</td>
               <td>{{ row.role_name }}</td>
               <td>{{ row.expiry }}</td>
               <td>
                  <div class="visible-desktop action-buttons session-actions"></div>
               </td>
            </tr>
            {% endfor %}
         </tbody>
      </table>
   </div>
</div>
{% endblock %}

{% block page_script %}
<script id="source" language="javascript" type="text/javascript">

   var role = '{{request.session.role}}';
   var user_name = '{{request.session.user}}';

   $('[data-rel=popover]').popover({html:true});

   function deleteUserCallback(name, status, details) {
       if (status == "success") {
           bdNotify('User ( ' + name + ' )' + ' successfully deleted', "success");
       }
       else {
           bdNotify('Failed to delete the user ( ' + name + ' )</br>' + details, "failed");
       }
   }

   registerDataTable('#users_table',
                     '#',
                     '{% url "userextras_view" %}?user_id=',
                     '#',
                     deleteUserCallback,
                     '.table_delete',
                     {{headers|safe}}, {{headers|length}},
                     0, 2);

   /* setup row action buttons...*/
   var url = '{% url "usersettings_view" %}?user_id=';
   for (var i = 0; i < oTable[0].fnGetData().length; i++) {
       var rowData = oTable[0].fnGetData(i);
    
       var button = '<div class="visible-desktop action-buttons row-actions">';

       button += insertExtrasButton();
       button += insertDeleteButton();

       if (role == 'Site Admin' && user_name != rowData[1] &&
             rowData[4].indexOf("Internal") == 0) {
           button += insertPasswordButton(url + rowData[0]);
       }

       button += '</div>';
       oTable[0].fnUpdate(button, i, 5, false);
   }


   registerDataTable('#user_sessions',
                     '#',
                     '#',
                     '{% url "manageuser_view" %}',
                     deleteCallback,
                     '.table_delete',
                     {{session_headers|safe}}, {{session_headers|length}},
                     1, 2);

   function deleteCallback(name, status, details) {
       if (status == "success") {
           bdNotify('Session for user ( ' + name + ' )' + ' successfully deleted', "success");
       }
       else {
           bdNotify('Failed to delete the session ( ' + name + ' )</br>' + details, "failed");
       }
   }

   /* setup row action buttons...*/
   for (var i = 0; i < oTable[1].fnGetData().length; i++) {
       var rowData = oTable[1].fnGetData(i);
    
       var button = '<div class="visible-desktop action-buttons row-actions">';
       button += insertDeleteButton();
       button += '</div>';
       oTable[1].fnUpdate(button, i, 6, false);
   }

</script>
{% endblock %}
