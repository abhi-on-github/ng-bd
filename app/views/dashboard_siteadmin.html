{% extends 'base.html' %}
{% load url from future %}
{% block main_content %}
<div class="span12" id='dashboardPage_siteAdmin'>
   <div class="tabbable">
      <ul class="nav nav-tabs padding-12 tab-color-blue ">
         <div id="nav-search" class="pull-right">
         </div>
         <li id="current_load_tab" class="active">
            <a data-toggle="tab" href="#current-load-tab">
               Current Load
            </a>
         </li>

         <li id="resourcess_tab">
            <a data-toggle="tab" href="#resources-tab">
               Resource Usage
            </a>
         </li>

         <li id="service_status_tab">
            <a data-toggle="tab" href="#service-status-tab">
               Service Status
            </a>
         </li>

         <li id="alerts_tab">
            <a data-toggle="tab"href="#alerts-tab">
               Alerts
            </a>
         </li>
      </ul>
<!--      <div class="space-6"></div> -->

      <div class="tab-content">
         <div id="current-load-tab" class="tab-pane in active">
            <div class="row-fluid">
               <div class="span12 infobox-container">
                  <div class="center infobox">
                     <div id="loadgauge"></div>
                  </div>

                  <div class="center infobox">
                     <div id="cpugauge"></div>
                  </div>

                  <div class="center infobox">
                     <div id="memgauge"></div>
                  </div>

                  <div class="center infobox">
                     <div id="netgauge"></div>
                  </div>
               </div>
            </div>
            </br>

            <div class="row-fluid">
               <div class="span12" style="height:400px;">
                  <div class="tabbable no-border">
                     <ul class="nav nav-tabs padding-12 no-border">
                        <div id="nav-search" class="pull-right">
                           <span class="pull-right">
                              <button id="period-title" class="btn btn-mini btn-success" data-toggle="dropdown">
                                 Last Hour
                                 <i class="icon-angle-down icon-on-right"></i>
                              </button>

                              <ul class="dropdown-menu dropdown-yellow pull-right dropdown-caret dropdown-close">
                                 <li>
                                    <a href="#" onclick="return stats_change('period-click', 'hour', 'Last Hour');">Last Hour</a>
                                 </li>

                                 <li>
                                    <a href="#" onclick="return stats_change('period-click', '2hr', '2 Hours');">2 Hours</a>
                                 </li>

                                 <li>
                                    <a href="#" onclick="return stats_change('period-click', '4hr', '4 Hours');">4 Hours</a>
                                 </li>

                                 <li>
                                    <a href="#" onclick="return stats_change('period-click', 'day', 'Day');">Day</a>
                                 </li>

                                 <li>
                                    <a href="#" onclick="return stats_change('period-click', 'week', 'Week');">Week</a>
                                 </li>
                                 <li>
                                    <a href="#" onclick="return stats_change('period-click', 'month', 'Month');">Month</a>
                                 </li>
                                 <li>
                                    <a href="#" onclick="return stats_change('period-click', 'year', 'Year');">Year</a>
                                 </li>
                              </ul>
                           </span>
                        </div>

                        <li id="load_tab" class="active">
                           <a data-toggle="tab" href="#load-chart-tab">
                              Load Average
                           </a>
                        </li>
                        <li id="cpu_tab">
                           <a data-toggle="tab" href="#cpu-chart-tab">
                              CPU
                           </a>
                        </li>
                        <li id="mem_tab">
                           <a data-toggle="tab" href="#mem-chart-tab">
                              Memory
                           </a>
                        </li>
                        <li id="net_tab">
                           <a data-toggle="tab" href="#net-chart-tab">
                              Network
                           </a>
                        </li>
                     </ul>

                     <div class="tab-content no-border">
                        <div id="load-chart-tab" class="tab-pane in active" >
                           <div class="row-fluid">
                              <div id="loadchart"></div>
                           </div>
                        </div>
                        <div id="cpu-chart-tab" class="tab-pane">
                           <div class="row-fluid">
                              <div id="cpuchart"></div>
                           </div>
                        </div>
                        <div id="mem-chart-tab" class="tab-pane">
                           <div class="row-fluid">
                              <div id="memchart"></div>
                           </div>
                        </div>
                        <div id="net-chart-tab" class="tab-pane">
                           <div class="row-fluid">
                              <div id="netchart"></div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <div id="resources-tab" class="tab-pane">
            <div class="row-fluid">
               <div class="span12">
                  <div class="infobox-container">
                     <div class="center infobox">
                        <div id="coreusage"></div>
                     </div>


                     <div class="center infobox">
                        <div id="memoryusage"></div>
                     </div>

                     <div class="infobox infobox-large">
                        <div id="tenantusage" class="pull-left"></div>
                     </div>
                  </div>
               </div>
            </div>
            </br>
            </br>

            <div class="row-fluid">
               <div class="span12 widget-container-span">
                  <div class="widget-box transparent">
                     <div class="widget-body" style="height:305px;">
                        <div class="widget-main no-padding">
                           <div class="slim-scroll" data-height="300">
                              <table class="table table-bordered table-striped" id="tenant_table">
                                 <thead>
                                    <tr>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          Tenant Name
                                       </th>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          Users
                                       </th>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          Cores
                                       </th>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          Memory (GB)
                                       </th>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          Clusters
                                       </th>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          Active Jobs
                                       </th>
                                    </tr>
                                 </thead>
                              </table>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <div id="service-status-tab" class="tab-pane">
            <div class="row-fluid">
               <div class="span12 widget-container-span">
                  <div class="widget-box transparent">
                     <div id ="phynode_spinner" style="position:absolute;top:50%;left:50%;width:50px;height:50px;" class="center"></div>
                     <div class="widget-body" style="height:350px;">
                        <div class="widget-main no-padding">
                           <div class="slim-scroll" data-height="345">
                              <table id='phynode' class="table table-bordered table-striped" style="height:40px;">
                                 <thead>
                                    <tr>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          Node Name
                                       </th>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          VM Count
                                       </th>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          Management Service
                                       </th>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          Data Service Agent
                                       </th>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          Data Service I/O
                                       </th>
                                       <th>
                                          <i class="icon-caret-right blue"></i>
                                          Name Node Service
                                       </th>
                                        <th>
                                          <i class="icon-caret-right blue"></i>
                                          Data Node Service
                                       </th>
                                    </tr>
                                 </thead>
                              </table>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <div id="alerts-tab" class="tab-pane">
            <div class="row-fluid">
               <div class="span12">
                  <div id="alerts"></div>
               </div>
            </div>

         </div>
      </div>
   </div>
</div>
{% endblock %}

{% block page_script %}
<script src="/bdswebui/static/bdswebui/js/rickshaw.min.js"  type="text/javascript"></script>
<script id="source" language="javascript" type="text/javascript">
   var colors = [];
   var graphs = [];
   var urls = [];
   var curr_data = "hour";
   var curr_title = "Last Hour";
   var tenant_list = {{tenant_list|safe}};
//   var piecolors = ['#acd7e6', '#ff7f10', '#c59d95', '#1f78b4', '#2ca02c'];
//   var piecolors = ['#ffbd72', '#ff7e00', '#95e085', '#aec6ea', '#1677b6'];
   var piecolors = ['#ffbd72', '#ff7e00', '#95e085', '#35bebe', '#fd423c'];

   // Sort tenant_list based on usage
   tenant_list.sort(function (a, b) {
       if (a.inusecores > b.inusecores){
           return -1;
       } else if (a.inusecores < b.inusecores){
           return 1;
       } else {
           return 0;
       }
   }).sort();
   
   // Populate the tenant table here..
   for (i = 0; i < tenant_list.length; i++) {
       data = tenant_list[i];
       var iconcolor = "";
       var tddata = '<td>' + iconcolor + data.name + '</td>';
       tddata += '<td>' + data.user_list.length + '</td>';
       if (data.name != "Site Admin") {
           tddata += '<td>' + data.inusecores + '</td>';
           tddata += '<td>' + data.inusememory + '</td>';
       }
       tddata += '<td>' + data.ready_clusters + '</td>';
       tddata += '<td>' + data.active_jobs + '</td>';
       $('#tenant_table').append("<tr>"+tddata+"</tr>");
   }

   function stats_change(from, data, title) {
       curr_data = data;
       curr_title = title;
       reloadChart();
   }
       
   function addDashboardPhynode(table_id, data, nagios_data) {
       table_data = get_nagios_data(nagios_data);
       console.log("table_data: ", table_data);
       var tddata = '<td>' + data.name + '</td>';
       tddata += '<td>' + data.vm_count + '</td>';
       tddata += table_data[1];
       tddata += table_data[2];
       tddata += table_data[3];
       tddata += table_data[4];
       tddata += table_data[5];
       $(table_id).append("<tr>"+tddata+"</tr>");
   }

   function updateDashboardPhyNodeList(url)
   {
       var data = {
           operation: 'get_pnode_list',
       };
       $.ajax({
           url: url,
           method: 'post',
           contentType: "application/json; charset=utf-8",
           data: JSON.stringify(data),
           csrfmiddlewaretoken: csrftoken,
           headers: {'X-CSRFToken' : csrftoken},
           success: function(result) {
               for (i = 0; i < result.pnode_list.length; i++) {
                   var data = result.pnode_list[i];
                   var found = false;
                   for (var j = 0; j < result.nagios_data.length; j++) {
                       if (data.name == result.nagios_data[j].host_name) {
                           found = true;
                           break;
                       }
                   }
                   if (found == true) {
                       // name, hadoop_distro, flavor, job_or_cluaster label
                       addDashboardPhynode('#phynode', result.pnode_list[i], result.nagios_data[j]);
                   }
               }

               var log = "";
               // Lets sort the json based on timestamp
               result.nagios_alerts.sort(function (a, b) {
                   if (a.timestamp > b.timestamp){
                       return -1;
                   } else if (a.timestamp < b.timestamp){
                       return 1;
                   } else {
                       return 0;
                   }
               }).sort();

               // Use upto 100 alerts
               log = '<ul class="unstyled spaced">';
               if (result.nagios_alerts.length) {
                   for (i = 0; i < result.nagios_alerts.length; i++) {
                       line = result.nagios_alerts[i];
                       log += get_alert_data_from_current_state(line);
                       //                   log += "[" + getDateTimeFromTimestamp(line.timestamp) + "]  " + line.line + '</br>';
                   }
               }
               else {
                   log += '<li>No alerts</li>';
               }
               log += '</ul>';
               // Filter logs that are not related to 
               $("#alerts").html(log);
           },
           error: function(result) {
               // Got an error. schedule a timer to retry again
               bdStartAjaxTimer(15, 'phynode_timer', updateDashboardPhyNodeList);
           },
       });
   }
   
   function updateData() {
       updateDashboardPhyNodeList('{% url "dashboard_view" %}');
       updateDashboardVirtNodeList('{% url "dashboard_view" %}', true);
   }

   colors['load'] = '#bae4e2';
   colors['cpu'] = '#ffdfb2';
   colors['mem'] = '#acd7e6';
   colors['net'] = '#e4c6e7';

   var url_prefix = 'http://' + '{{controller_ip}}' + '/ganglia/graph.php';
   var url_suffix = '&c=BlueDataCluster-'+'{{host_name}}'+'&m=load_one&s=by+name&mc=2&json=1';
   initializeURLS();

   initializeGraphs();

   function initializeURLS() {
       urls['load'] = url_prefix + '?r=hour' + '&g=load_report' + url_suffix;
       urls['cpu'] = url_prefix + '?r=hour' + '&g=cpu_report' + url_suffix;
       urls['mem'] = url_prefix + '?r=hour' + '&g=mem_report' + url_suffix;
       urls['net'] = url_prefix + '?r=hour' + '&g=network_report' + url_suffix;
   }

   function initializeGraphs() {
       var width = $('.tab-content').outerWidth()-50;
       height = 300;
       graphs['load'] = new bdsGraph();
       graphs['cpu'] = new bdsGraph();
       graphs['mem'] = new bdsGraph();
       graphs['net'] = new bdsGraph();

       graphs['load'].initialize(width, height, "load", "#loadchart", '1-min', 'stack', colors['load'], urls['load'], updateLoadChart, curr_data);
       graphs['cpu'].initialize(width, height, "cpu", "#cpuchart", 'User', 'stack', colors['cpu'], urls['cpu'], updateCPUChart, curr_data);
       graphs['mem'].initialize(width, height, "mem", "#memchart", 'Use', 'stack', colors['mem'], urls['mem'], updateMemChart, curr_data);
       graphs['net'].initialize(width, height, "net", "#netchart", 'Network', 'stack', colors['net'], urls['net'], updateNetChart, curr_data);

       var gauge_height = 140;

       zones = [{"from" : 0, "to" : 0, "color" : colors['load']},
                {"from" : 0, "to" : {{total_cores}}, "color": '#f1f1f1'}];
       createGauge2("load","Load ", '0', 'loadgauge', gauge_height, 0, {{total_cores}}, zones);

       // This will be percentage
       zones = [{"from" : 0, "to" : 0, "color" : colors['cpu']},
                {"from" : 0, "to" : 100, "color": '#f1f1f1'}];
       createGauge2("cpu","CPU %", '0', 'cpugauge', gauge_height, 0, 100, zones);

       // We need the total Memory for all the nodes..
       zones = [{"from" : 0, "to" : 0, "color" : colors['mem']},
                {"from" : 0, "to" : {{total_memory}}, "color": '#f1f1f1'}];
       createGauge2("mem","Memory (GB)", '0', 'memgauge', gauge_height, 0, {{total_memory}}, zones);

       // This should be in Mbps. For now assuming max of Gbps???
       zones = [{"from" : 0, "to" : 0, "color" : colors['net']},
                {"from" : 0, "to" : 1000, "color": '#f1f1f1'}];
       createGauge2("net","Network", '0', 'netgauge', gauge_height, 0, 1000, zones);

       var size = 140;
       var val1, val2;
       var used_cores = {{used_cores}};

       val1 = {{total_cores}};
       val2 = {{used_cores}};

       var data = [{"value":used_cores, "color":colors['cpu']},
                   {"value":{{remaining_cores}}, "color":"#f1f1f1"}];

       perc = (used_cores/{{total_cores}})*100;
       createDonut("#coreusage", data, perc, size, perc.toFixed() + "%", "Cores Used");

       val1 = {{total_memory}};
       val2 = {{used_memory}};

       data = [{"value":{{used_memory}}, "color":colors['mem']},
               {"value":{{remaining_memory}}, "color":"#f1f1f1"}];
       perc = ({{used_memory}}/{{total_memory}})*100;
       createDonut("#memoryusage", data, perc, size, perc.toFixed() + "%", "Memory Used");

       // Go through the tenant list and find the top 5 tenants that are using total number of vms
       // If we have less than 6 then we can show all the tenants. For more than 6, we have to include
       // an others section
       data = [];
       // Get the top 4 tenants
       var acc_cores = 0;
       for (var i = 0; i < Math.min(4, tenant_list.length); i++) {
           if (tenant_list[i].name == "Site Admin" || tenant_list[i].inusecores == 0) {
               continue;
           }
           var dat = {"index" : i, "name" : tenant_list[i].name, "value" : tenant_list[i].inusecores, "color" : piecolors[i]}
           acc_cores += tenant_list[i].inusecores;
           data.push(dat);
       }

       if (tenant_list.length > 4 && (used_cores-acc_cores) > 0) {
           var dat = {"index" : -1, "name" : "Others", "value" : {{used_cores}}-acc_cores, "color" : piecolors[4]}
           data.push(dat);
       }

       if (acc_cores == 0) {
           $('#tenantusage').parent().css({"background-color": "#f3f3f3"});
       }

       createMultiDonut("#tenantusage", data, size, 282, "Usage by Tenants", acc_cores);
   }

   window.onresize = function(event) {
       // Empty individual graphs
       graphs['load'].destroy();
       graphs['cpu'].destroy();
       graphs['mem'].destroy();
       graphs['net'].destroy();

       $('.rickshaw_graph').empty();

       
       $('#loadgauge').empty();
       $('#cpugauge').empty();
       $('#netgauge').empty();
       $('#memgauge').empty();
       $('#coreusage').empty();
       $('#memoryusage').empty();
       $('#tenantusage').empty();

       initializeGraphs();
   };


   function reloadChart() {
       // Clear the time interval
       urls['load'] = url_prefix + '?r=' + curr_data + '&g=load_report' + url_suffix;
       urls['cpu'] = url_prefix + '?r=' + curr_data + '&g=cpu_report' + url_suffix;
       urls['mem'] = url_prefix + '?r=' + curr_data + '&g=mem_report' + url_suffix;
       urls['net'] = url_prefix + '?r=' + curr_data + '&g=network_report' + url_suffix;

       $('#period-title').html(curr_title+'    <span class="caret"></span>');

       graphs['load'].reload(urls['load'], curr_data);
       graphs['cpu'].reload(urls['cpu'], curr_data);
       graphs['mem'].reload(urls['mem'], curr_data);
       graphs['net'].reload(urls['net'], curr_data);
   }
   function hoverCallback(data) {
       var index = data.index;
       if (index == -1) {
           html = '<p><span>' + 'Others' + '</span></p>';
       }
       else {
           var tenant_data = tenant_list[index];
           html = '<p><span>' + tenant_data.name + '</span></p>';
       }
       return html;
   }

   updateData();

</script>
{% endblock %}

